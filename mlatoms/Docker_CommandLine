export PROJECT_ID=$(gcloud config list project --format "value(core.project)")
export IMAGE_REPO_NAME=mnist_pytorch_custom_container
export IMAGE_TAG=mnist_pytorch_cpu
export IMAGE_URI=gcr.io/$PROJECT_ID/$IMAGE_REPO_NAME:$IMAGE_TAG

docker build -f Dockerfile -t $IMAGE_URI ./

# Run image locally
docker run $IMAGE_URI --epochs 1

# Upload image
docker push $IMAGE_URI



export PROJECT_ID=$(gcloud config list project --format "value(core.project)")
export IMAGE_REPO_NAME=sklearn_test_hypertune
export IMAGE_TAG=sklearn_hpt
export IMAGE_URI=gcr.io/$PROJECT_ID/$IMAGE_REPO_NAME:$IMAGE_TAG

docker build -f LogisticRegression_DockerFile -t $IMAGE_URI ./

# Run image locally
docker run $IMAGE_URI --C 1 --penalty l2

# Upload image
docker push $IMAGE_URI


# Job Request
export BUCKET_NAME=ml_train_deploy_test
export MODEL_DIR=sklearn_model_$(date +%Y%m%d_%H%M%S)
export REGION=us-central1
export JOB_NAME=custom_container_job_$(date +%Y%m%d_%H%M%S)

gcloud beta ai-platform jobs submit training $JOB_NAME \
  --region $REGION \
  --master-image-uri $IMAGE_URI \
  -- \
  --model-dir=gs://$BUCKET_NAME/$MODEL_DIR \
  --C=0.5 \
  --penalty l1


# Job Request with HPT
export BUCKET_NAME=ml_train_deploy_test
export MODEL_DIR=sklearn_model_$(date +%Y%m%d_%H%M%S)
export REGION=us-central1
export JOB_NAME=custom_container_job_$(date +%Y%m%d_%H%M%S)

gcloud beta ai-platform jobs submit training $JOB_NAME \
  --region $REGION \
  --master-image-uri $IMAGE_URI \
  --config /Numerai_2.0/mlatoms/ht_config.yml \
  -- \
  --model-dir=gs://$BUCKET_NAME/$MODEL_DIR \
  --train-files=gs://$BUCKET_NAME/sample_data/sample_data.csv